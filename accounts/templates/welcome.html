{% load static %}
{% block title %}Feed{% endblock %}

{% block content %}
<!-- Link to CSS -->
<link rel="stylesheet" href="{% static 'welcome.css' %}">

<!-- Modal Form -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Create a Post</h3>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_image" class="file-label">Select Photo
                    <input type="file" name="image" id="id_image" accept="image/*" required>
                </label>
                {% if post_form.image.errors %}
                    <div class="form-error">{{ post_form.image.errors }}</div>
                {% endif %}
                <div class="form-group">
                    <label for="id_caption">Caption</label>
                    {{ post_form.caption }}
                    {% if post_form.caption.errors %}
                        <div class="form-error">{{ post_form.caption.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <button type="submit" class="post-btn">Share</button>
        </form>
    </div>
</div>

<!-- Instagram-style Layout -->
<div class="main-layout">
    <!-- Sidebar Profile -->
    <aside class="sidebar-left">
        <div class="profile-card">
            <h2>{{ user.username }}</h2>
            <a href="{% url 'logout_view' %}" class="logout-link">Log Out</a>
            <button id="openPostModal" class="new-post-btn">New Post</button>
        </div>
    </aside>

    <!-- Feed Section -->
    <section class="scrollable-feed">
        {% if messages %}
            <div class="message-container">
                {% for message in messages %}
                    <div class="alert {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
        {% for post in posts %}
            <article class="feed-post">
                <div class="post-header">
                    <div class="user-info">
                        <strong>{{ post.user.username }}</strong>
                    </div>
                    <span class="timestamp">{{ post.created_at|timesince }} ago</span>
                </div>
                <img src="{{ post.image.url }}" class="post-img" alt="{{ post.caption }}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 614 614%22><rect width=%22614%22 height=%22614%22 fill=%22%23dbdbdb%22/><text x=%2250%%22 y=%2250%%22 font-size=%2214%22 fill=%22%238e8e8e%22 text-anchor=%22middle%22 dy=%22.3em%22>Post Image</text></svg>';">
                <div class="post-actions">
                    <button class="action-btn">â™¥</button>
                    <button class="action-btn">ðŸ’¬</button>
                    <button class="action-btn">âœˆ</button>
                </div>
                <p class="caption"><strong>{{ post.user.username }}</strong> {{ post.caption }}</p>
                <div class="comments">
                    {% for comment in post.comments.all %}
                        <p><strong>{{ comment.user.username }}</strong> {{ comment.text }}</p>
                    {% endfor %}
                    <form method="POST" action="{% url 'add_comment' post.id %}">
                        {% csrf_token %}
                        <input type="text" name="text" placeholder="Add a comment..." required>
                        <button type="submit" class="comment-btn">Post</button>
                    </form>
                </div>
            </article>
        {% endfor %}
    </section>
</div>

<!-- Link to JavaScript -->
<script src="{% static 'welcome.js' %}"></script>
{% endblock %}