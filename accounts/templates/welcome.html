{% load static %}
{% block title %}Feed{% endblock %}

{% block content %}
<!-- Link to CSS -->
<link rel="stylesheet" href="{% static 'welcome.css' %}">

<!-- Modal Form -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Create a Post</h3>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_image" class="file-label">Select Photo
                    <input type="file" name="image" id="id_image" accept="image/*" required>
                </label>
                {% if post_form.image.errors %}
                    <div class="form-error">{{ post_form.image.errors }}</div>
                {% endif %}
                <div class="form-group">
                    <label for="id_caption">Caption</label>
                    {{ post_form.caption }}
                    {% if post_form.caption.errors %}
                        <div class="form-error">{{ post_form.caption.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <button type="submit" class="post-btn">Share</button>
        </form>
    </div>
</div>

<!-- Instagram-style Layout -->
<div class="main-layout">
    <!-- Sidebar Profile -->
    <aside class="sidebar-left">
        <div class="profile-card">
            <h2>{{ user.username }}</h2>
            <a href="{% url 'logout_view' %}" class="logout-link">Log Out</a>
            <button id="openPostModal" class="new-post-btn">New Post</button>
        </div>
    </aside>

    <!-- Feed Section -->
    <section class="scrollable-feed">
        {% if messages %}
            <div class="message-container">
                {% for message in messages %}
                    <div class="alert {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
        {% for post_data in posts_with_comments %}
            <article class="feed-post" data-post-id="{{ post_data.post.id }}">
                <div class="post-header">
                    <div class="user-info">
                        <strong>{{ post_data.post.user.username }}</strong>
                    </div>
                    <span class="timestamp">{{ post_data.post.created_at|timesince }} ago</span>
                </div>
                <img src="{{ post_data.post.image.url }}" class="post-img" alt="Post {{ post_data.post.id }}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 614 614%22><rect width=%62614%22 height=%62614%22 fill=%22%23dbdbdb%22/><text x=%2250%%22 y=%2250%%22 font-size=%2214%22 fill=%22%238e8e8e%22 text-anchor=%22middle%22 dy=%22.3em%22>Post Image</text></svg>';">
                <div class="post-actions">
                    <button class="action-btn like-btn" data-post-id="{{ post_data.post.id }}" data-liked="false">â™¥</button>
                    <button class="action-btn comment-btn" data-post-id="{{ post_data.post.id }}">ðŸ’¬</button>
                    <button class="action-btn">âœˆ</button>
                </div>
                <p class="caption"><strong>{{ post_data.post.user.username }}</strong> {{ post_data.post.caption }}</p>
                <div class="comments-section" data-post-id="{{ post_data.post.id }}">
                    <!-- Comment count and load more -->
                    {% if post_data.total_comments > 2 %}
                        <div class="view-comments">
                            <button class="view-all-comments" data-post-id="{{ post_data.post.id }}">View all {{ post_data.total_comments }} comments</button>
                        </div>
                    {% endif %}
                    <!-- Top-level comments -->
                    <div class="comments-container" data-post-id="{{ post_data.post.id }}">
                        {% for comment in post_data.top_level_comments %}
                            <div class="comment-thread" data-comment-id="{{ comment.id }}" {% if forloop.counter0 >= 2 %}style="display: none;"{% endif %}>
                                <div class="comment" data-comment-id="{{ comment.id }}">
                                    <p><strong>{{ comment.user.username }}</strong> {{ comment.text }}</p>
                                    <button class="reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                                    <div class="reply-form-container" style="display: none;">
                                        <form method="POST" action="{% url 'add_comment' post_data.post.id %}" class="reply-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                            <input type="text" name="text" placeholder="Reply to {{ comment.user.username }}..." required>
                                            <button type="submit" class="comment-btn">Post</button>
                                        </form>
                                    </div>
                                </div>
                                <!-- Nested replies -->
                                <div class="replies-container">
                                    {% for reply in comment.replies.all %}
                                        <div class="reply" data-reply-id="{{ reply.id }}">
                                            <p><strong>{{ reply.user.username }}</strong> {{ reply.text }}</p>
                                            <button class="reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <!-- Main comment form -->
                    <div class="main-comment-form">
                        <form method="POST" action="{% url 'add_comment' post_data.post.id %}">
                            {% csrf_token %}
                            <input type="text" name="text" placeholder="Add a comment..." required>
                            <button type="submit" class="comment-btn">Post</button>
                        </form>
                    </div>
                </div>
            </article>
        {% endfor %}
    </section>
</div>

<!-- Link to JavaScript -->
<script src="{% static 'welcome.js' %}"></script>
{% endblock %}